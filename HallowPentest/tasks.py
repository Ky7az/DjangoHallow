from celery import shared_task
import io
import paramiko
import select

from HallowPentest.models import Task


@shared_task
def run_task(task_id):
    task = Task.objects.get(id=task_id)
    attacker = task.attacker

    private_key_file = io.StringIO()
    private_key_file.write(attacker.ssh_pkey)
    private_key_file.seek(0)
    pkey = paramiko.Ed25519Key.from_private_key(private_key_file)

    ssh_client = paramiko.SSHClient()
    ssh_client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    ssh_client.connect(hostname=task.attacker.host, port=attacker.ssh_port, username=attacker.ssh_username, look_for_keys=False, pkey=pkey)

    stdin, stdout, stderr = ssh_client.exec_command(task.command)

    stdin.close()                 
    stdout.channel.shutdown_write()  

    stdout_chunks = []
    while not stdout.channel.exit_status_ready():
        rl, wl, xl = select.select([stdout.channel], [], [], 0.0)
        for c in rl:
            if c.recv_ready():
                stdout_chunks.append(stdout.channel.recv(len(c.in_buffer)))
                task.output += stdout_chunks[-1].decode('utf-8')
                task.save()

    stdout.close()
    stderr.close()
    ssh_client.close()
