from string import Formatter

from django.core.exceptions import ObjectDoesNotExist
from django.db.models import Q
from rest_framework import serializers

from HallowPentest.models import (Action, Attacker, Credential, Parameter,
                                  Phase, Port, Service, Target, TargetService,
                                  Task, Tool, Vulnerability)
from HallowPentest.tasks import run_task


class AttackerSerializer(serializers.ModelSerializer):

    class Meta:
        model = Attacker
        fields = ('id',
                  'name',
                  'slug',
                  'host',
                  'ssh_port',
                  'ssh_username',
                  'ssh_pkey')


class PortSerializer(serializers.ModelSerializer):

    class Meta:
        model = Port
        fields = ('id',
                  'slug',
                  'number',
                  'protocol')


class ServiceSerializer(serializers.ModelSerializer):

    default_ports = PortSerializer(many=True)

    class Meta:
        model = Service
        fields = ('id',
                  'name',
                  'slug',
                  'default_ports')


class TargetSerializer(serializers.ModelSerializer):

    class Meta:
        model = Target
        fields = ('id',
                  'name',
                  'slug',
                  'host',
                  'path')


class TargetServiceSerializer(serializers.ModelSerializer):

    target = TargetSerializer(read_only=True)
    service = ServiceSerializer(read_only=True)
    port = PortSerializer(read_only=True)

    class Meta:
        model = TargetService
        fields = ('id',
                  'target',
                  'target_id',
                  'service',
                  'service_id',
                  'port',
                  'port_id')

        extra_kwargs = {
            'target_id': {'source': 'target', 'write_only': True},
            'service_id': {'source': 'service', 'write_only': True},
            'port_id': {'source': 'port', 'write_only': True}
        }


class CredentialSerializer(serializers.ModelSerializer):

    target = TargetSerializer(read_only=True)
    service = ServiceSerializer(read_only=True)

    class Meta:
        model = Credential
        fields = ('id',
                  'target',
                  'target_id',
                  'service',
                  'service_id',
                  'cred_type',
                  'username',
                  'password')

        extra_kwargs = {
            'target_id': {'source': 'target', 'write_only': True},
            'service_id': {'source': 'service', 'write_only': True}
        }


class PhaseSerializer(serializers.ModelSerializer):

    class Meta:
        model = Phase
        fields = ('id',
                  'name',
                  'slug',
                  'sequence')


class VulnerabilitySerializer(serializers.ModelSerializer):

    class Meta:
        model = Vulnerability
        fields = ('id',
                  'name',
                  'slug')


class ToolSerializer(serializers.ModelSerializer):

    class Meta:
        model = Tool
        fields = ('id',
                  'name',
                  'slug',
                  'url')


class ParameterSerializer(serializers.ModelSerializer):

    target = TargetSerializer(read_only=True)
    tool = ToolSerializer(read_only=True)

    class Meta:
        model = Parameter
        fields = ('id',
                  'target',
                  'target_id',
                  'tool',
                  'tool_id',
                  'name',
                  'key',
                  'value')

        extra_kwargs = {
            'target_id': {'source': 'target', 'write_only': True},
            'tool_id': {'source': 'tool', 'write_only': True}
        }


class ActionSerializer(serializers.ModelSerializer):

    phase = PhaseSerializer()
    service = ServiceSerializer()
    vulnerability = VulnerabilitySerializer()
    tool = ToolSerializer()

    class Meta:
        model = Action
        fields = ('id',
                  'name',
                  'phase',
                  'service',
                  'vulnerability',
                  'tool',
                  'auth_needed',
                  'command',
                  'priority')


class TaskSerializer(serializers.ModelSerializer):

    attacker = AttackerSerializer(read_only=True)
    target = TargetSerializer(read_only=True)
    target_service = TargetServiceSerializer(read_only=True)
    credential = CredentialSerializer(read_only=True)
    action = ActionSerializer(read_only=True)

    class Meta:
        model = Task
        fields = ('id',
                  'create_date',
                  'write_date',
                  'attacker',
                  'attacker_id',
                  'target',
                  'target_id',
                  'target_service',
                  'target_service_id',
                  'credential',
                  'credential_id',
                  'action',
                  'action_id',
                  'command')

        extra_kwargs = {
            'attacker_id': {'source': 'attacker', 'write_only': True},
            'target_id': {'source': 'target', 'write_only': True},
            'target_service_id': {'source': 'target_service', 'write_only': True},
            'credential_id': {'source': 'credential', 'write_only': True},
            'action_id': {'source': 'action', 'write_only': True},
            'command': {'required': False}
        }

    def format_command(self, task_data):
        target = task_data['target']
        target_service = task_data['target_service']
        action = task_data['action']

        format_data = {
            'host': target.host,
            'port': target_service and target_service.port.number or '',
            'path': target.path
        }

        if credential := task_data['credential']:
            format_data |= {'username': credential.username, 'password': credential.password}

        action_fnames = [fname for text, fname, spec, conv in Formatter().parse(action.command) if fname not in format_data.keys() and fname is not None]
        for action_fname in action_fnames:
            try:
                param = Parameter.objects.get(key=action_fname, target=target, tool=action.tool)
            except ObjectDoesNotExist:
                try:
                    param = Parameter.objects.get(key=action_fname, target=target, tool__isnull=True)
                except ObjectDoesNotExist:
                    try:
                        param = Parameter.objects.get(key=action_fname, target__isnull=True, tool=action.tool)
                    except ObjectDoesNotExist:
                        try:
                            param = Parameter.objects.get(key=action_fname, target__isnull=True, tool__isnull=True)
                        except ObjectDoesNotExist as e:
                            raise ObjectDoesNotExist(f'Missing parameter "{action_fname}"') from e

            format_data[param.key] = param.value

        return action.command.format(**format_data)

    def create(self, validated_data):
        validated_data['command'] = self.format_command(validated_data)
        task = Task.objects.create(**validated_data)

        res = run_task.delay(task.id)
        task.celery_task_id = res.id
        task.save()

        return task
