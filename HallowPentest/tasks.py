import io
import re
import select
import time

import paramiko
from celery import shared_task

from HallowPentest.models import Attacker, Task


def paramiko_ssh_connect(attacker):
    """ SSH connection with Paramiko """

    private_key_file = io.StringIO()
    private_key_file.write(attacker.ssh_pkey)
    private_key_file.seek(0)
    pkey = paramiko.Ed25519Key.from_private_key(private_key_file)

    ssh_client = paramiko.SSHClient()
    ssh_client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    ssh_client.connect(hostname=attacker.host, port=attacker.ssh_port, username=attacker.ssh_username, look_for_keys=False, pkey=pkey)
    return ssh_client

@shared_task
def run_task(task_id):

    task = Task.objects.get(id=task_id)
    ssh_client = paramiko_ssh_connect(task.attacker)

    stdin, stdout, stderr = ssh_client.exec_command(task.command)

    stdin.close()                 
    stdout.channel.shutdown_write()  

    stdout_chunks = []
    while not stdout.channel.exit_status_ready():
        rl, wl, xl = select.select([stdout.channel], [], [], 0.0)
        for c in rl:
            if c.recv_ready():
                stdout_chunks.append(stdout.channel.recv(len(c.in_buffer)))
                task.output += stdout_chunks[-1].decode('utf-8')
                task.save()

    stdout.close()
    stderr.close()
    ssh_client.close()

@shared_task
def clean_task(attacker_id, task_command):

    attacker = Attacker.objects.get(id=attacker_id)
    ssh_client = paramiko_ssh_connect(attacker)

    stdin, stdout, stderr = ssh_client.exec_command(f'pgrep -f "{task_command}"')
    if task_pid := stdout.read().decode('utf-8').rstrip('\n'):
        ssh_client.exec_command(f'kill {task_pid}')

    stdin.close()
    stdout.close()
    stderr.close()
    ssh_client.close()